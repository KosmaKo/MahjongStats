@page "/refresh"
@using MahjongStats.Models
@using MahjongStats.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject IMahjongTrackerService MahjongService
@inject IGameFilterService FilterService
@inject IDatabaseService DatabaseService
@inject IConfiguration Configuration
@inject NavigationManager Navigation
@inject IAuthService AuthService
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<PageTitle>Refresh Data - Mahjong Stats</PageTitle>

@if (!isAuthenticated)
{
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-4">üîê Access Restricted</h5>
                        <p class="text-muted mb-4">You need to sign in with your Google account to access the refresh functionality.</p>
                        <a href="/auth/login?returnUrl=/refresh" class="btn btn-primary btn-lg">
                            Sign in with Google
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    return;
}

@if (!isAuthorized)
{
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-4">‚ùå Access Denied</h5>
                        <p class="text-muted mb-4">Your email (<strong>@userEmail</strong>) is not authorized to access this page.</p>
                        <a href="/auth/logout" class="btn btn-secondary">
                            Sign out
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    return;
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1>üîÑ Refresh Data</h1>
            <p class="text-muted">Sync your Mahjong game data with the API.</p>
        </div>
        <div class="text-end">
            <small class="text-muted d-block mb-2">Signed in as: <strong>@userEmail</strong></small>
            <a href="/auth/logout" class="btn btn-sm btn-outline-secondary">Sign out</a>
        </div>
    </div>

    <!-- Status Section -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Database Status</h5>
            @if (cachedGameCount > 0)
            {
                <div class="alert alert-success">
                    <strong>‚úì Database is populated</strong>
                    <br/>
                    <small>Games in database: @cachedGameCount</small>
                    <br/>
                    <small>Rounds in database: @cachedRoundCount</small>
                </div>
            }
            else
            {
                <div class="alert alert-warning">
                    <strong>‚ö† Database is empty</strong>
                    <br/>
                    <small>Sync data below to populate the database</small>
                </div>
            }
        </div>
    </div>

    <!-- Bearer Token Input -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Bearer Token</h5>
        </div>
        <div class="card-body">
            <div class="input-group">
                <input type="text" class="form-control" @bind="bearerToken" placeholder="Paste your bearer token from mahjongtracker.com" disabled="@isLoading">
            </div>
            @if (!string.IsNullOrEmpty(tokenError))
            {
                <div class="alert alert-danger mt-3">@tokenError</div>
            }
        </div>
    </div>

    <!-- Refresh Games Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Refresh Games</h5>
        </div>
        <div class="card-body">
            <p>Refresh all games created since the specified date. Missing rounds will be fetched automatically.</p>
            
            <div class="mb-3">
                <label class="form-label">Refresh Since Date</label>
                <input type="date" class="form-control" @bind="refreshSinceDate" disabled="@(isLoading || string.IsNullOrEmpty(bearerToken))">
                <small class="text-muted">Default: 2 weeks ago</small>
            </div>

            <button class="btn btn-success w-100" style="padding: 0.75rem;" @onclick="RefreshGamesSince" disabled="@(isLoading || string.IsNullOrEmpty(bearerToken))">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Refreshing Games...</span>
                }
                else
                {
                    <span>üîÑ Refresh Games Since</span>
                }
            </button>

            @if (refreshSinceMessage != null)
            {
                <div class="alert @(refreshSinceMessage.IsError ? "alert-danger" : "alert-success") mt-3 mb-0">@refreshSinceMessage.Text</div>
            }

            <!-- Throttle Delay Setting -->
            <div class="mb-3">
                <label class="form-label">Throttle Delay (milliseconds)</label>
                <div class="input-group" style="max-width: 200px">
                    <input type="number" class="form-control" @bind="throttleDelay" min="100" step="100" disabled="@isLoading">
                    <span class="input-group-text">ms</span>
                </div>
                <small class="text-muted">Delay between API requests to avoid rate limiting. Recommended: 100-500ms</small>
            </div>
        </div>
    </div>

    <!-- Summary -->
    <div class="card bg-light">
        <div class="card-body">
            <h5 class="card-title">Summary</h5>
            <ul>
                <li><strong>Games in database:</strong> @cachedGameCount</li>
                <li><strong>Rounds in database:</strong> @cachedRoundCount</li>
            </ul>
        </div>
    </div>
</div>

@code {
    private class Message
    {
        public string Text { get; set; }
        public bool IsError { get; set; }
        public string AlertClass => IsError ? "alert-danger" : "alert-success";
    }

    private string bearerToken = "";
    private string tokenError = "";

    private bool isLoading = false;

    private int throttleDelay = 100;
    private DateTime refreshSinceDate = DateTime.Today.AddDays(-14); // Default: 2 weeks ago
    private int cachedGameCount = 0;
    private int cachedRoundCount = 0;

    private Message? refreshSinceMessage;

    private void LoadBearerToken()
    {
        var token = Configuration["MahjongTracker:BearerToken"];
        if (!string.IsNullOrEmpty(token) && token != "YOUR_BEARER_TOKEN_HERE")
        {
            bearerToken = token;
        }
    }

    private async Task UpdateCacheStats()
    {
        try
        {
            var allGames = await DatabaseService.GetAllGamesAsync();
            cachedGameCount = allGames.Count;
            
            var allRounds = await DatabaseService.GetAllRoundsAsync();
            cachedRoundCount = allRounds.Values.Sum(r => r.Count);
        }
        catch
        {
            cachedGameCount = 0;
            cachedRoundCount = 0;
        }
    }

    private async Task RefreshGamesSince()
    {
        if (string.IsNullOrEmpty(bearerToken))
        {
            tokenError = "Bearer token is required";
            return;
        }

        isLoading = true;
        refreshSinceMessage = null;

        try
        {
            // Step 1: Refresh games
            refreshSinceMessage = new Message { Text = $"Refreshing games since {refreshSinceDate:yyyy-MM-dd}...", IsError = false };
            StateHasChanged();
            
            var refreshedGames = await MahjongService.SyncGamesFromDateAsync(refreshSinceDate, bearerToken);
            
            // Step 2: Automatically fetch missing rounds
            refreshSinceMessage = new Message { Text = $"Fetched {refreshedGames.Count} game(s). Now fetching missing rounds...", IsError = false };
            StateHasChanged();
            
            var (syncedGameIds, totalRounds) = await MahjongService.SyncAllMissingRoundsAsync(bearerToken, throttleDelayMs: throttleDelay);
            
            // Final message
            if (refreshedGames.Any())
            {
                refreshSinceMessage = new Message { 
                    Text = $"‚úì Refreshed {refreshedGames.Count} game(s) and {totalRounds} rounds since {refreshSinceDate:yyyy-MM-dd}", 
                    IsError = false 
                };
            }
            else
            {
                refreshSinceMessage = new Message { Text = $"No games found after {refreshSinceDate:yyyy-MM-dd}", IsError = false };
            }

            await UpdateCacheStats();
        }
        catch (Exception ex)
        {
            refreshSinceMessage = new Message { Text = $"Error: {ex.Message}", IsError = true };
        }
        finally
        {
            isLoading = false;
        }
    }

    // Authentication state
    private bool isAuthenticated = false;
    private bool isAuthorized = false;
    private string? userEmail = "";

    protected override async Task OnInitializedAsync()
    {
        LoadBearerToken();
        await CheckAuthenticationState();
        await UpdateCacheStats();
    }

    private async Task CheckAuthenticationState()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            isAuthenticated = user?.Identity?.IsAuthenticated ?? false;

            if (isAuthenticated)
            {
                // Get email from claims
                userEmail = user?.FindFirst(ClaimTypes.Email)?.Value 
                    ?? user?.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress")?.Value
                    ?? user?.FindFirst("email")?.Value;

                // Check if email is in whitelist
                isAuthorized = AuthService.IsUserAuthorized(userEmail);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Auth check error: {ex.Message}");
            isAuthenticated = false;
            isAuthorized = false;
            userEmail = "";
        }
    }
}
