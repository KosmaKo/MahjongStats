@page "/games"
@using MahjongStats.Models
@using MahjongStats.Services
@using MahjongStats.Components.Pages.GameComponents
@inject IGameFilterService FilterService
@inject IPlayerStatsService StatsService
@inject IDatabaseService DatabaseService
@rendermode InteractiveServer

<PageTitle>Mahjong Statistics</PageTitle>

<div class="container-fluid mt-4">
    <h1>ðŸ“Š Mahjong Statistics</h1>
    <p class="text-muted">View your game statistics. Use the <a href="/refresh" class="text-decoration-none">Refresh</a> page to update data.</p>

    @if (isLoadingGames)
    {
        <div class="alert alert-info">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Please be patient, the data is loading, it might take a moment
        </div>
    }
    else if (games.Count == 0)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>No data loaded!</strong> 
            Go to the <a href="/refresh" class="alert-link">Refresh</a> page to fetch your games first.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (games != null && games.Count > 0)
    {
        <FilterSection 
            @bind-IsExpanded="isFiltersExpanded"
            PlayerFilters="playerFilters"
            @bind-MinDateFilter="minDateFilter"
            @bind-MaxDateFilter="maxDateFilter"
            AllPlayerNames="allPlayerNames"
            OnApplyFilters="ApplyFilters"
            OnClearFilters="ClearFilters" />

        <div class="alert alert-info">
            <strong>Games:</strong> Showing @filteredGames.Count of @games.Count games
            @if (!string.IsNullOrEmpty(filterSummary))
            {
                <br/>
                <strong>Active Filters:</strong> @filterSummary
            }
        </div>

        <PinnedStatsSection 
            @bind-IsExpanded="isPinnedStatsExpanded"
            PinnedStats="pinnedStats"
            OnClearAll="ClearAllPinnedStats"
            OnUnpin="UnpinStats" />

        <PlayerStatsSection 
            @bind-IsExpanded="isPlayerStatsExpanded"
            PlayerStats="playerStats"
            IsLoading="isLoadingStats"
            OnPin="PinStats" />

        <OverallResultsSection 
            @bind-IsExpanded="isOverallResultsExpanded"
            Results="overallResults" />

        <GameRecordsSection 
            @bind-IsExpanded="isGamesListExpanded"
            FilteredGames="filteredGames"
            GameRoundsMap="gameRoundsMap"
            ExpandedGameId="expandedGameId"
            OnToggleGame="ToggleGameExpanded" />
    }
</div>

@code {
    private List<MahjongGame> games = new();
    private List<MahjongGame> filteredGames = new();
    private Dictionary<string, List<RoundDetail>> gameRoundsMap = new();
    private Dictionary<string, PlayerStats> playerStats = new();
    private OverallResults? overallResults = null;
    private string? expandedGameId = null;
    private bool isLoadingStats = false;
    private bool isLoadingGames = true;
    private List<string> allPlayerNames = new();
    private List<PinnedStatsSection.PinnedPlayerStats> pinnedStats = new();

    private bool isFiltersExpanded = true;
    private bool isPinnedStatsExpanded = true;
    private bool isPlayerStatsExpanded = true;
    private bool isOverallResultsExpanded = true;
    private bool isGamesListExpanded = true;

    private DateTime? minDateFilter;
    private DateTime? maxDateFilter;
    private List<string> playerFilters = new() { "", "", "", "" };
    private string filterSummary = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            games = await DatabaseService.GetAllGamesAsync();
            filteredGames = games;
            
            var allRounds = await DatabaseService.GetAllRoundsAsync();
            gameRoundsMap = new Dictionary<string, List<RoundDetail>>(allRounds);
            
            allPlayerNames = games
                .SelectMany(g => g.Players)
                .Where(p => !string.IsNullOrWhiteSpace(p.Name))
                .Select(p => p.Name!.ToUpper())
                .Distinct()
                .OrderBy(name => name)
                .ToList();
        }
        finally
        {
            isLoadingGames = false;
        }
        
        minDateFilter = new DateTime(2025, 1, 1);
    }

    private void ApplyFilters()
    {
        if (games == null || games.Count == 0) return;

        var playerNames = playerFilters.Where(p => !string.IsNullOrWhiteSpace(p)).ToList();
        filteredGames = FilterService.FilterGames(games, minDateFilter, maxDateFilter, playerNames.Count > 0 ? playerNames : null);

        var summaryParts = new List<string>();
        if (minDateFilter.HasValue) summaryParts.Add($"From {minDateFilter:yyyy-MM-dd}");
        if (maxDateFilter.HasValue) summaryParts.Add($"Until {maxDateFilter:yyyy-MM-dd}");
        if (playerNames.Count > 0) summaryParts.Add($"Players: {string.Join(", ", playerNames)}");
        filterSummary = summaryParts.Count > 0 ? string.Join(" | ", summaryParts) : "";
        
        _ = CalculateStatsForFilteredPlayers(playerNames);
        if (playerNames.Count > 0) _ = CalculateOverallResults(playerNames);
        else overallResults = null;
    }

    private void ClearFilters()
    {
        minDateFilter = null;
        maxDateFilter = null;
        playerFilters = new() { "", "", "", "" };
        filterSummary = "";
        filteredGames = games;
        playerStats.Clear();
        overallResults = null;
    }

    private async Task CalculateStatsForFilteredPlayers(List<string> playerNames)
    {
        if (playerNames.Count == 0 || filteredGames.Count == 0)
        {
            playerStats.Clear();
            return;
        }

        isLoadingStats = true;
        playerStats.Clear();
        
        try
        {
            foreach (var playerName in playerNames)
            {
                var stats = await StatsService.CalculateStatsAsync(filteredGames, playerName, DatabaseService);
                if (stats.GamesPlayed > 0) playerStats[playerName] = stats;
            }
        }
        finally
        {
            isLoadingStats = false;
        }
    }

    private async Task CalculateOverallResults(List<string> playerNames)
    {
        if (playerNames.Count == 0 || filteredGames.Count == 0)
        {
            overallResults = null;
            return;
        }

        try
        {
            overallResults = await StatsService.CalculateOverallResultsAsync(filteredGames, playerNames);
        }
        catch
        {
            overallResults = null;
        }
    }

    private void PinStats(PlayerStats stats)
    {
        var contextParts = new List<string>();
        if (minDateFilter.HasValue) contextParts.Add($"From {minDateFilter:yyyy-MM-dd}");
        if (maxDateFilter.HasValue) contextParts.Add($"To {maxDateFilter:yyyy-MM-dd}");
        var context = contextParts.Count > 0 ? string.Join(" | ", contextParts) : "All dates";
        
        var existingPin = pinnedStats.FirstOrDefault(p => 
            p.Stats.PlayerName.Equals(stats.PlayerName, StringComparison.OrdinalIgnoreCase) && 
            p.FilterContext == context);
        
        if (existingPin == null)
        {
            pinnedStats.Add(new PinnedStatsSection.PinnedPlayerStats { Stats = stats, FilterContext = context });
        }
    }

    private void UnpinStats(PinnedStatsSection.PinnedPlayerStats pinnedStat) => pinnedStats.Remove(pinnedStat);
    
    private void ClearAllPinnedStats() => pinnedStats.Clear();

    private void ToggleGameExpanded(string? gameId)
    {
        expandedGameId = expandedGameId == gameId ? null : gameId;
    }

    private string GetPlayerNameBySeat(MahjongGame game, string? seat)
    {
        if (string.IsNullOrEmpty(seat)) return "Unknown";

        int? playerIndex = null;
        
        if (seat.StartsWith("Player", StringComparison.OrdinalIgnoreCase))
        {
            var numberPart = seat.Substring(6);
            if (int.TryParse(numberPart, out int playerNumber) && playerNumber >= 1 && playerNumber <= 4)
            {
                playerIndex = playerNumber - 1;
            }
        }
        else if (int.TryParse(seat, out int directIndex))
        {
            playerIndex = directIndex;
        }

        if (playerIndex.HasValue && playerIndex >= 0 && playerIndex < game.Players.Count)
        {
            return game.Players[playerIndex.Value].Name ?? "Unknown";
        }

        return seat;
    }
}

