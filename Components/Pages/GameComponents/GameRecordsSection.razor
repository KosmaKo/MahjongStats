@using MahjongStats.Models

<div class="card mb-4">
    <div class="card-header" style="cursor: pointer;" @onclick="ToggleExpanded">
        <h5 class="card-title mb-0">
            @(IsExpanded ? "â–¼" : "â–¶") Game Records
        </h5>
    </div>
    @if (IsExpanded)
    {
        <div class="card-body">
            @if (FilteredGames.Count > 0)
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Players</th>
                                <th>Round</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var game in FilteredGames)
                            {
                                <tr style="cursor: pointer;" @onclick="() => OnToggleGame.InvokeAsync(game.Id)">
                                    <td>
                                        <small>@game.CreatedDateTime.ToString("yyyy-MM-dd HH:mm")</small>
                                    </td>
                                    <td>
                                        @foreach (var player in game.Players)
                                        {
                                            <span class="badge bg-secondary me-1">@player.Name</span>
                                        }
                                    </td>
                                    <td>@(game.Round ?? "-")</td>
                                    <td>
                                        @if (GameRoundsMap.ContainsKey(game.Id) && GameRoundsMap[game.Id].Count > 0)
                                        {
                                            <span class="badge bg-success">@GameRoundsMap[game.Id].Count Rounds</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning">Pending</span>
                                        }
                                    </td>
                                </tr>
                                @if (ExpandedGameId == game.Id && GameRoundsMap.ContainsKey(game.Id) && GameRoundsMap[game.Id].Count > 0)
                                {
                                    <tr class="table-active">
                                        <td colspan="4">
                                            <div class="p-3">
                                                <h6 class="mb-3">Game Summary - Final Standings</h6>
                                                <div class="table-responsive mb-4">
                                                    <table class="table table-sm table-bordered mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Rank</th>
                                                                <th>Player</th>
                                                                <th>Points</th>
                                                                <th>Uma</th>
                                                                <th>Total</th>
                                                                <th>Chombo</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @{
                                                                var standings = new List<(string PlayerName, int TotalPoints, int Rank)>();
                                                                for (int i = 0; i < game.Players.Count; i++)
                                                                {
                                                                    var playerName = game.Players[i].Name ?? "Unknown";
                                                                    var totalPoints = game.Points[i].Sum();
                                                                    standings.Add((playerName, totalPoints, 0));
                                                                }
                                                                standings = standings.OrderByDescending(x => x.TotalPoints).ToList();
                                                                for (int rank = 0; rank < standings.Count; rank++)
                                                                {
                                                                    standings[rank] = (standings[rank].PlayerName, standings[rank].TotalPoints, rank + 1);
                                                                }
                                                            }
                                                            @foreach (var standing in standings)
                                                            {
                                                                var playerIndex = Array.IndexOf(game.Players.Select(p => p.Name).ToArray(), standing.PlayerName);
                                                                var points = 0;
                                                                var uma = 0;
                                                                var chomboCount = 0;
                                                                if (playerIndex >= 0)
                                                                {
                                                                    points = game.Points[playerIndex][0];
                                                                    uma = game.Points[playerIndex].Count >= 2 ? game.Points[playerIndex][1] : 0;
                                                                    chomboCount = game.Points[playerIndex].Count >= 3 ? game.Points[playerIndex][2] : 0;
                                                                }
                                                                <tr>
                                                                    <td><strong>@standing.Rank</strong></td>
                                                                    <td>@standing.PlayerName</td>
                                                                    <td>
                                                                        <span style="color: @(points > 0 ? "#28a745" : points < 0 ? "#dc3545" : "#6c757d");">
                                                                            @(points > 0 ? "+" : "")@points
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        <span style="color: @(uma > 0 ? "#28a745" : uma < 0 ? "#dc3545" : "#6c757d");">
                                                                            @(uma > 0 ? "+" : "")@uma
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        <span style="font-weight: bold; color: @(standing.TotalPoints > 0 ? "#28a745" : standing.TotalPoints < 0 ? "#dc3545" : "#6c757d");">
                                                                            @(standing.TotalPoints > 0 ? "+" : "")@standing.TotalPoints
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        @if (chomboCount != 0)
                                                                        {
                                                                            <span class="badge bg-danger">@Math.Abs(chomboCount)</span>
                                                                        }
                                                                    </td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <hr class="my-3"/>
                                                <h6 class="mb-3">Rounds for @game.Round</h6>
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-bordered mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Round</th>
                                                                <th>Outcome</th>
                                                                <th>Winner/Loser</th>
                                                                <th>Score</th>
                                                                <th>Points</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var round in GameRoundsMap[game.Id])
                                                            {
                                                                <tr>
                                                                    <td><small>@round.Round</small></td>
                                                                    <td>
                                                                        <span class="badge @(round.Outcome == "Ron" ? "bg-info" : round.Outcome == "Tsumo" ? "bg-success" : round.Outcome == "Draw" ? "bg-warning" : "bg-secondary")">
                                                                            @round.Outcome
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        <small>
                                                                            @if (round.Outcome == "Ron")
                                                                            {
                                                                                var winnerSeat = round.Data?.Winners?.FirstOrDefault()?.Seat;
                                                                                var winnerName = GetPlayerNameBySeat(game, winnerSeat);
                                                                                var loserName = GetPlayerNameBySeat(game, round.Data?.LoserSeat);
                                                                                <span class="text-success"><strong>W:</strong> @winnerName</span>
                                                                                <br/>
                                                                                <span class="text-danger"><strong>L:</strong> @loserName</span>
                                                                            }
                                                                            else if (round.Outcome == "Tsumo")
                                                                            {
                                                                                var winnerName = GetPlayerNameBySeat(game, round.Data?.WinnerSeat);
                                                                                <span class="text-success"><strong>W:</strong> @winnerName</span>
                                                                            }
                                                                            else
                                                                            {
                                                                                <span class="text-muted">-</span>
                                                                            }
                                                                        </small>
                                                                    </td>
                                                                    <td>
                                                                        <small>
                                                                            @if (round.Data?.Score != null)
                                                                            {
                                                                                <span>@round.Data.Score.Han Han @(round.Data.Score.Fu ?? 0) Fu</span>
                                                                            }
                                                                            else
                                                                            {
                                                                                <span class="text-muted">-</span>
                                                                            }
                                                                        </small>
                                                                    </td>
                                                                    <td>
                                                                        <small>
                                                                            @if (round.Points != null && round.Points.Count > 0)
                                                                            {
                                                                                @for (int i = 0; i < game.Players.Count && i < round.Points.Count; i++)
                                                                                {
                                                                                    var playerName = game.Players[i].Name;
                                                                                    var playerPoints = round.Points[i];
                                                                                    var totalPoints = playerPoints.Count > 0 ? playerPoints.Sum() : 0;
                                                                                    var playerSeat = $"Player{i + 1}";
                                                                                    var didRiichi = round.Data?.Riichi != null && round.Data.Riichi.Contains(playerSeat);
                                                                                    <span style="color: @(totalPoints > 0 ? "#28a745" : totalPoints < 0 ? "#dc3545" : "#6c757d");">
                                                                                        @playerName: @(totalPoints > 0 ? "+" : "")@totalPoints
                                                                                        @if (didRiichi)
                                                                                        {
                                                                                            <span title="Riichi">ðŸ€„</span>
                                                                                        }
                                                                                    </span>
                                                                                    @if (i < game.Players.Count - 1)
                                                                                    {
                                                                                        <br/>
                                                                                    }
                                                                                }
                                                                            }
                                                                            else
                                                                            {
                                                                                <span class="text-muted">-</span>
                                                                            }
                                                                        </small>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted">No games match your filters. Try adjusting the date range or player names.</p>
            }
        </div>
    }
</div>

@code {
    [Parameter] public bool IsExpanded { get; set; } = true;
    [Parameter] public EventCallback<bool> IsExpandedChanged { get; set; }
    [Parameter] public List<MahjongGame> FilteredGames { get; set; } = new();
    [Parameter] public Dictionary<string, List<RoundDetail>> GameRoundsMap { get; set; } = new();
    [Parameter] public string? ExpandedGameId { get; set; }
    [Parameter] public EventCallback<string?> OnToggleGame { get; set; }

    private async Task ToggleExpanded()
    {
        IsExpanded = !IsExpanded;
        await IsExpandedChanged.InvokeAsync(IsExpanded);
    }

    private string GetPlayerNameBySeat(MahjongGame game, string? seat)
    {
        if (string.IsNullOrEmpty(seat)) return "Unknown";

        int? playerIndex = null;
        
        if (seat.StartsWith("Player", StringComparison.OrdinalIgnoreCase))
        {
            var numberPart = seat.Substring(6);
            if (int.TryParse(numberPart, out int playerNumber) && playerNumber >= 1 && playerNumber <= 4)
            {
                playerIndex = playerNumber - 1;
            }
        }
        else if (int.TryParse(seat, out int directIndex))
        {
            playerIndex = directIndex;
        }

        if (playerIndex.HasValue && playerIndex >= 0 && playerIndex < game.Players.Count)
        {
            return game.Players[playerIndex.Value].Name ?? "Unknown";
        }

        return seat;
    }
}
